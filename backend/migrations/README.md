# –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π (Refactored)

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞

–í–º–µ—Å—Ç–æ 19 –º–∏–≥—Ä–∞—Ü–∏–π —Ç–µ–ø–µ—Ä—å **4 –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–∞**:

### 1Ô∏è‚É£ `m240101_000001_create_all_tables.php`
**–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏ —Å—Ö–µ–º –ë–î**
- –°—Ö–µ–º—ã: `auth`, `compliance`, `finance`, `audit`
- –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ (–≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
- –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
- –ò–Ω–¥–µ–∫—Å—ã

**–í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Å—Ç–∞—Ä—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:**
- m230101_000000_init
- m230101_000110_calendar
- m230101_000120_finance_extend
- m230101_000130_risks
- m230101_000140_rls_users_orgs (—Ç–∞–±–ª–∏—Ü—ã)
- m230101_000180_add_filename_to_artifacts
- m230101_000230_add_requirement_to_artifacts
- m230101_000240_add_statuses_to_finance
- m230101_000250_create_audit_log

---

### 2Ô∏è‚É£ `m240101_000002_configure_rls.php`
**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Row-Level Security**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —Å `org_id`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**–í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Å—Ç–∞—Ä—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:**
- m230101_000100_rls
- m230101_000140_rls_users_orgs (RLS)
- m230101_000220_enable_rls_all_tables

---

### 3Ô∏è‚É£ `m240101_000003_seed_dictionaries.php`
**–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (requirements, risks)**
- 14 —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —ç–∫–æ–ª–æ–≥–∏–∏ (—Å –±–∏—Ç–æ–≤—ã–º–∏ –º–∞—Å–∫–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
- 4 —Ä–∏—Å–∫–∞
- –ì–æ—Ç–æ–≤—ã–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã–µ

**–í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Å—Ç–∞—Ä—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:**
- m230101_000150_seed_requirements
- m230101_000160_seed_risks

---

### 4Ô∏è‚É£ `m240101_000004_seed_demo_data.php`
**–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
- 4 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin, manager, specialist, client)
- 5 –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –°–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–¥–æ–≥–æ–≤–æ—Ä—ã, —Å—á–µ—Ç–∞, –∞–∫—Ç—ã)

**–í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Å—Ç–∞—Ä—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:**
- m230101_000170_seed_admin
- m230101_000190_seed_demo_data
- m230101_000200_seed_demo_users
- m230101_000210_seed_demo_finance
- m230101_000260_seed_demo_organizations
- m230101_000270_seed_demo_finance

---

## üéØ –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–ª–∏–µ–Ω—Ç–∞

### ‚ùå –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
- –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–µ–ª –≤—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É `users_orgs`

### ‚úÖ –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–æ–ª—å        ‚îÇ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏          ‚îÇ –ö–æ–ª-–≤–æ   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ admin       ‚îÇ –í—Å–µ                  ‚îÇ 5        ‚îÇ
‚îÇ manager     ‚îÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ 1-3        ‚îÇ 4        ‚îÇ
‚îÇ specialist  ‚îÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ 1-2        ‚îÇ 3        ‚îÇ
‚îÇ client      ‚îÇ "–û–û–û –î–µ–º–æ –ö–ª–∏–µ–Ω—Ç"    ‚îÇ 1 ‚úÖ     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª–∏–µ–Ω—Ç –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏!**

---

## üìä –î–µ–º–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

1. **–û–û–û "–î–µ–º–æ –ö–ª–∏–µ–Ω—Ç"** (–ò–ù–ù: 1234567890)
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è II, —Å–∫–≤–∞–∂–∏–Ω–∞
   - –î–æ—Å—Ç—É–ø: admin, client

2. **–û–û–û "–≠–∫–æ–ü—Ä–æ–º"** (–ò–ù–ù: 7701234567)
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è I, —Ä–µ–∫–∞, –ø–æ–±–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
   - –î–æ—Å—Ç—É–ø: admin, manager, specialist

3. **–ê–û "–ü—Ä–∏—Ä–æ–¥–∞ –ü–ª—é—Å"** (–ò–ù–ù: 7702345678)
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è II, —Å–∫–≤–∞–∂–∏–Ω–∞
   - –î–æ—Å—Ç—É–ø: admin, manager, specialist

4. **–û–û–û "–ì—Ä–∏–Ω–¢–µ—Ö"** (–ò–ù–ù: 7703456789)
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è III, —Ä–µ–∫–∞, –ø–æ–±–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
   - –î–æ—Å—Ç—É–ø: admin, manager

5. **–û–û–û "–≠–∫–æ –†–µ—à–µ–Ω–∏—è"** (–ò–ù–ù: 7705678901)
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è II, —Å–∫–≤–∞–∂–∏–Ω–∞, –ø–æ–±–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
   - –î–æ—Å—Ç—É–ø: admin, manager, specialist

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### –ü–æ–ª–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose down

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ë–î
docker volume rm lk-glav-prirod_postgres_data

# 3. –ó–∞–º–µ–Ω–∏—Ç—å –ø–∞–ø–∫—É –º–∏–≥—Ä–∞—Ü–∏–π
cd backend
rm -rf migrations
mv migrations_new migrations

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
cd ..
docker compose up -d --build

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker compose exec backend php yii migrate --interactive=0
```

### –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```
Total 4 new migrations to be applied:
    m240101_000001_create_all_tables
    m240101_000002_configure_rls
    m240101_000003_seed_dictionaries
    m240101_000004_seed_demo_data

*** applying m240101_000001_create_all_tables
‚úÖ Schemas created
‚úÖ Auth tables created
‚úÖ Compliance tables created
‚úÖ Finance tables created
‚úÖ Audit tables created
‚úÖ Foreign keys created
üéâ All tables created successfully!
*** applied m240101_000001_create_all_tables (time: 0.XXXs)

*** applying m240101_000002_configure_rls
‚úÖ RLS enabled on compliance.organizations
‚úÖ RLS enabled on compliance.client_requirements
‚úÖ RLS enabled on compliance.artifacts
‚úÖ RLS enabled on compliance.calendar_events
‚úÖ RLS enabled on finance.contracts
‚úÖ RLS enabled on finance.invoices
‚úÖ RLS enabled on finance.acts
üéâ RLS policies configured successfully!
*** applied m240101_000002_configure_rls (time: 0.XXXs)

*** applying m240101_000003_seed_dictionaries
‚úÖ 14 requirements inserted
‚úÖ 4 risks inserted
üéâ Dictionaries seeded successfully!
*** applied m240101_000003_seed_dictionaries (time: 0.XXXs)

*** applying m240101_000004_seed_demo_data
‚úÖ User created: admin@example.com / admin (admin)
‚úÖ User created: manager@example.com / manager (manager)
‚úÖ User created: specialist@example.com / specialist (specialist)
‚úÖ User created: client@example.com / client (client)

‚úÖ Organization created: –û–û–û "–î–µ–º–æ –ö–ª–∏–µ–Ω—Ç" (category 2)
   ‚Üí 7 requirements generated
   ‚Üí 5 calendar events created
... (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)

üéâ Demo data seeded successfully!

=== ACCESS SUMMARY ===
üë§ admin@example.com / admin ‚Üí 5 organizations (all)
üë§ manager@example.com / manager ‚Üí 4 organizations (categories 1-3)
üë§ specialist@example.com / specialist ‚Üí 3 organizations (categories 1-2)
üë§ client@example.com / client ‚Üí 1 organization (–û–û–û "–î–µ–º–æ –ö–ª–∏–µ–Ω—Ç" only)
*** applied m240101_000004_seed_demo_data (time: 0.XXXs)


4 migrations were applied.
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

1. **–ú–µ–Ω—å—à–µ —Ñ–∞–π–ª–æ–≤:** 4 –≤–º–µ—Å—Ç–æ 19
2. **–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** –¢–∞–±–ª–∏—Ü—ã ‚Üí RLS ‚Üí –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ‚Üí –î–∞–Ω–Ω—ã–µ
3. **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Ä–µ—à–∞–µ—Ç –æ–¥–Ω—É –±–æ–ª—å—à—É—é –∑–∞–¥–∞—á—É
4. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:** –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
5. **–õ–µ–≥–∫–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏:** –ü—Ä–æ—â–µ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥
6. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞ –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º–∞

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø:

```sql
-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 1)
SELECT o.name 
FROM compliance.organizations o
JOIN auth.users_orgs uo ON o.id = uo.org_id
JOIN auth.users u ON uo.user_id = u.id
WHERE u.email = 'client@example.com';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –û–û–û "–î–µ–º–æ –ö–ª–∏–µ–Ω—Ç"

-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 4)
SELECT o.name, o.category
FROM compliance.organizations o
JOIN auth.users_orgs uo ON o.id = uo.org_id
JOIN auth.users u ON uo.user_id = u.id
WHERE u.email = 'manager@example.com'
ORDER BY o.category;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 4 –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π 1, 2, 2, 3
```

---

## üìù –õ–æ–≥–∏–∫–∞ –±–∏—Ç–æ–≤—ã—Ö –º–∞—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

```
–ö–∞—Ç–µ–≥–æ—Ä–∏—è I   = 1 = 0b0001
–ö–∞—Ç–µ–≥–æ—Ä–∏—è II  = 2 = 0b0010
–ö–∞—Ç–µ–≥–æ—Ä–∏—è III = 4 = 0b0100
–ö–∞—Ç–µ–≥–æ—Ä–∏—è IV  = 8 = 0b1000

–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ = 15 = 0b1111
I-III         = 7  = 0b0111
I-II          = 3  = 0b0011
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏:
```php
(requirement.category_mask & (1 << (org.category - 1))) > 0
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 14 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0 (Refactored)
